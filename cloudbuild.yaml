steps:
  - name: gcr.io/cloud-builders/docker
    args:
      - build
      - "-t"
      - "${_AR_HOSTNAME}/${PROJECT_ID}/${_AR_REPO}/${_SERVICE_NAME}:${COMMIT_SHA}"
      - "."

  - name: gcr.io/cloud-builders/docker
    args:
      - push
      - "${_AR_HOSTNAME}/${PROJECT_ID}/${_AR_REPO}/${_SERVICE_NAME}:${COMMIT_SHA}"

  - name: gcr.io/google.com/cloudsdktool/cloud-sdk
    entrypoint: gcloud
    args:
      - run
      - deploy
      - "${_SERVICE_NAME}"
      - "--image"
      - "${_AR_HOSTNAME}/${PROJECT_ID}/${_AR_REPO}/${_SERVICE_NAME}:${COMMIT_SHA}"
      - "--region"
      - "${_DEPLOY_REGION}"
      - "--platform"
      - "managed"
      - "--quiet"

      # ---- GPU ----
      - "--gpu"
      - "1"
      - "--gpu-type"
      - "nvidia-l4"
      - "--no-gpu-zonal-redundancy"

      # ---- Resources ----
      - "--cpu"
      - "8"
      - "--memory"
      - "32Gi"
      - "--no-cpu-throttling"
      - "--concurrency"
      - "1"

      # ---- Scaling ----
      - "--min-instances"
      - "0"
      - "--max-instances"
      - "1"

      # ---- Access ----
      - "--allow-unauthenticated"

timeout: 1200s

images:
  - "${_AR_HOSTNAME}/${PROJECT_ID}/${_AR_REPO}/${_SERVICE_NAME}:${COMMIT_SHA}"

options:
  logging: CLOUD_LOGGING_ONLY

substitutions:
  _DEPLOY_REGION: "us-central1"
  _SERVICE_NAME: "sam3"
  _AR_REPO: "YOUR_AR_REPO"         # e.g. "containers"
  _AR_HOSTNAME: "us-central1-docker.pkg.dev"