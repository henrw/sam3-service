steps:
  - name: gcr.io/cloud-builders/docker
    args:
      - build
      - "-t"
      - "${_AR_HOSTNAME}/${PROJECT_ID}/${_AR_REPO}/${_SERVICE_NAME}:${COMMIT_SHA}"
      - "."

  - name: gcr.io/cloud-builders/docker
    args:
      - push
      - "${_AR_HOSTNAME}/${PROJECT_ID}/${_AR_REPO}/${_SERVICE_NAME}:${COMMIT_SHA}"

  # 1) Pre-set service scaling bounds (fixes existing maxScale=100)
  - name: gcr.io/google.com/cloudsdktool/cloud-sdk
    entrypoint: gcloud
    args:
      - run
      - services
      - update
      - "${_SERVICE_NAME}"
      - "--region"
      - "${_DEPLOY_REGION}"
      - "--platform"
      - "managed"
      - "--max-instances=1"
      - "--min-instances=0"
      - "--quiet"

  # 2) Deploy revision with GPU + no GPU zonal redundancy + force maxScale=1
  - name: gcr.io/google.com/cloudsdktool/cloud-sdk
    entrypoint: gcloud
    args:
      - run
      - deploy
      - "${_SERVICE_NAME}"
      - "--image"
      - "${_AR_HOSTNAME}/${PROJECT_ID}/${_AR_REPO}/${_SERVICE_NAME}:${COMMIT_SHA}"
      - "--region"
      - "${_DEPLOY_REGION}"
      - "--platform"
      - "managed"
      - "--quiet"

      # ---- GPU ----
      - "--gpu=1"
      - "--gpu-type=nvidia-l4"
      - "--no-gpu-zonal-redundancy"

      # ---- Resources ----
      - "--cpu=8"
      - "--memory=32Gi"
      - "--no-cpu-throttling"
      - "--concurrency=1"

      # ---- Scaling (force) ----
      - "--max-instances=1"
      - "--min-instances=0"
      # Force the underlying revision annotation explicitly:
      - "--update-annotations=autoscaling.knative.dev/maxScale=1,autoscaling.knative.dev/minScale=0"

      # ---- Access ----
      - "--allow-unauthenticated"

timeout: 1200s

images:
  - "${_AR_HOSTNAME}/${PROJECT_ID}/${_AR_REPO}/${_SERVICE_NAME}:${COMMIT_SHA}"

options:
  logging: CLOUD_LOGGING_ONLY